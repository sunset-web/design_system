{"version":3,"file":"comments.bundle.js","sources":["../src/comment.js","../src/commentsStore.js","../src/comments.js"],"sourcesContent":["export const CommentCard = {\r\n  mounted() {\r\n    this.$nextTick(function () {\r\n      this.$refs.elem.scrollIntoView();\r\n    });\r\n  },\r\n  props: [\"comment\"],\r\n  computed: {\r\n    htmlText() {\r\n      // функция из index.js\r\n      return findAndReplaceLink(this.comment.text);\r\n    },\r\n  },\r\n  /* html */\r\n  template: `\r\n    <li ref=\"elem\" class=\"comments__item\" :data-id=\"comment.id\">\r\n      <div class=\"comments__date\">{{comment.date}}</div>\r\n      <div class=\"comments__message\">{{$Bitrix.Loc.getMessage('COMMENT_USER', {'#USER#': comment.user})}}{{comment.user}}</div>\r\n      <div class=\"comments__text\" v-html=\"htmlText\"></div>\r\n    </li>\r\n  `,\r\n};\r\n","import { defineStore } from \"ui.vue3.pinia\";\n\nexport const commentsStore = defineStore(\"commentsStore\", {\n  state: () => {\n    return {\n      units: [],\n    };\n  },\n  actions: {\n    getUnit(id) {\n      let arrInStore = this.units.find((unit) => unit.id === id);\n      return arrInStore;\n    },\n    constructUnit(id, comments) {\n      let arrInStore = this.units.find((unit) => unit.id === id);\n      if (arrInStore) {\n        arrInStore.comments = comments;\n      } else {\n        this.units.push({\n          id: id,\n          comments: comments,\n        });\n      }\n    },\n    createComments(id, comment) {\n      let arrInStore = this.units.find((unit) => unit.id === id);\n      if (arrInStore) {\n        arrInStore.comments.push(comment);\n      } else {\n        this.units.push({\n          id: id,\n          comments: comment,\n        });\n      }\n      return comment.id;\n    },\n    loadComments(id, comments) {\n      let arrInStore = this.units.find((unit) => unit.id === id);\n      arrInStore.comments.unshift(...comments);\n    },\n  },\n});\n","import { BitrixVue } from \"ui.vue3\";\nimport { CommentCard } from \"./comment\";\nimport { createPinia, mapState, mapActions } from \"ui.vue3.pinia\";\nimport { commentsStore } from \"./commentsStore\";\nconst store = createPinia();\n\nexport class Comments {\n\t#application;\n\n\tconstructor(rootNode) {\n\t\tthis.rootNode = document.querySelector(rootNode);\n\t}\n\n\tinit(id) {\n\t\tthis.#application = BitrixVue.createApp({\n\t\t\tcomponents: {\n\t\t\t\tCommentCard,\n\t\t\t},\n\t\t\tdata() {\n\t\t\t\treturn {\n\t\t\t\t\titemID: id,\n\t\t\t\t\ttext: \"\",\n\t\t\t\t\tloading: false,\n\t\t\t\t};\n\t\t\t},\n\t\t\tcomputed: {\n\t\t\t\t...mapState(commentsStore, [\"units\"]),\n\t\t\t\tcommentsLoc() {\n\t\t\t\t\tlet u = this.units.filter((e) => e.id == this.itemID)[0];\n\t\t\t\t\tlet res = u ? u.comments : null;\n\t\t\t\t\treturn res;\n\t\t\t\t},\n\t\t\t\toffset() {\n\t\t\t\t\treturn this.commentsLoc.length;\n\t\t\t\t},\n\t\t\t},\n\t\t\tmethods: {\n\t\t\t\tsend(e) {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tBX.ajax\n\t\t\t\t\t\t.runComponentAction(\"itin:comments\", \"create\", {\n\t\t\t\t\t\t\tmode: \"class\",\n\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\tunit: this.itemID,\n\t\t\t\t\t\t\t\ttext: this.text,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then((response) => {\n\t\t\t\t\t\t\tthis.text = \"\";\n\t\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tload() {\n\t\t\t\t\tif (this.$refs.list.scrollTop < 300 && !this.loading) {\n\t\t\t\t\t\tthis.loading = true;\n\t\t\t\t\t\tBX.ajax\n\t\t\t\t\t\t\t.runComponentAction(\"itin:comments\", \"get\", {\n\t\t\t\t\t\t\t\tmode: \"class\",\n\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\tunit: this.itemID,\n\t\t\t\t\t\t\t\t\toffset: this.offset,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then((response) => {\n\t\t\t\t\t\t\t\tthis.loadComments(this.itemID, response.data.result);\n\t\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t\tthis.loading = false;\n\t\t\t\t\t\t\t\t}, 300);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t...mapActions(commentsStore, {\n\t\t\t\t\tconstructUnit: \"constructUnit\",\n\t\t\t\t\tgetUnit: \"getUnit\",\n\t\t\t\t\tcreateComments: \"createComments\",\n\t\t\t\t\tloadComments: \"loadComments\",\n\t\t\t\t}),\n\t\t\t},\n\t\t\tmounted() {\n\t\t\t\tlet arrInStore = this.getUnit(this.itemID);\n\t\t\t\tif (!arrInStore) {\n\t\t\t\t\tBX.ajax\n\t\t\t\t\t\t.runComponentAction(\"itin:comments\", \"get\", {\n\t\t\t\t\t\t\tmode: \"class\",\n\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\tunit: this.itemID,\n\t\t\t\t\t\t\t\toffset: 0,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then((response) => {\n\t\t\t\t\t\t\tthis.constructUnit(this.itemID, response.data.result);\n\t\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\t/* html */\n\t\t\ttemplate: `\n\t\t\t\t\t<ul ref=\"list\" class=\"comments__list\" @scroll.prevent=\"load\">\n\t\t\t\t\t\t<CommentCard v-for=\"comment in commentsLoc\" :comment=\"comment\" :key=\"comment.id\"></CommentCard>\n\t\t\t\t\t</ul>\n\t\t\t\t\t<div class=\"comments__functional\">\n\t\t\t\t\t\t<textarea v-model=\"text\" name=\"new-comment\" :placeholder=\"$Bitrix.Loc.getMessage('NEW_COMMENT_PH')\"></textarea>\n\t\t\t\t\t\t<div class=\"comments__button-group flex fd-column-xs\">\n\t\t\t\t\t\t\t<button type=\"submit\" class=\"btn-blue p13-24 comment-js-create-btn\" @click=\"send\">{{$Bitrix.Loc.getMessage('COMMENT_SEND_BTN')}}</button>\n\t\t\t\t\t\t\t<button class=\"btn-white p13-24 cancel\">{{$Bitrix.Loc.getMessage('COMMENT_CANCLE_BTN')}}</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n    `,\n\t\t});\n\t\tthis.#application.use(store).mount(this.rootNode);\n\t}\n\n\tdestroy() {\n\t\tthis.#application.unmount();\n\t}\n}\n\nBX.PULL.start();\nBX.addCustomEvent(\"onPullEvent\", (module_id, command, params) => {\n\tif (module_id == \"addnewcommentnotification\" && command == \"sendComment\") {\n\t\tconsole.log(params);\n\t\tcommentsStore().createComments(params.response.id, params.response.res);\n\t\tupdateList();\n\t\t$(\".comment-notification-js\").addClass(\"active-notification\");\n\t\tsetTimeout(() => {\n\t\t\t$(\".comment-notification-js\").removeClass(\"active-notification\");\n\t\t}, 4000);\n\t}\n});\n"],"names":["CommentCard","mounted","$nextTick","$refs","elem","scrollIntoView","props","computed","htmlText","findAndReplaceLink","comment","text","template","commentsStore","defineStore","state","units","actions","getUnit","id","arrInStore","find","unit","constructUnit","comments","push","createComments","loadComments","_arrInStore$comments","unshift","apply","babelHelpers","toConsumableArray","store","createPinia","_application","WeakMap","Comments","rootNode","classCallCheck","_classPrivateFieldInitSpec","writable","value","document","querySelector","createClass","key","init","classPrivateFieldSet","BitrixVue","createApp","components","data","itemID","loading","_objectSpread","mapState","commentsLoc","_this","u","filter","e","res","offset","length","methods","send","_this2","preventDefault","BX","ajax","runComponentAction","mode","then","response","load","_this3","list","scrollTop","result","setTimeout","mapActions","_this4","classPrivateFieldGet","use","mount","destroy","unmount","PULL","start","addCustomEvent","module_id","command","params","console","log","updateList","$","addClass","removeClass"],"mappings":"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"}